<!DOCTYPE html>

<html lang="en">

        <head>
                <!-- Page information -->
                <meta charset="UTF-8" />
                <meta name="node_id" content="overview of architecture">
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="shortcut icon" href="/favicon.ico" />

                <!-- Set title -->
                <title>QuantumPeepz/RedPitayaGuide</title>

                <!-- Includes -->
                <script src="/obs.html/static/obsidian_core.js"></script>
<script src="/obs.html/static/encoding.js"></script>
<link rel="stylesheet" href="/obs.html/static/master.css" />
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
            'securityLevel': 'loose',
            'theme': 'dark',
            'themeVariables': {
                    'darkMode': true,
            }
    });
</script>
<script>
  MathJax = {
    loader: {
      load: [
        '[tex]/action',
        'output/chtml',
        '[tex]/centernot'
      ]
    },
    tex: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ["\\[","\\]"] ],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['centernot']}
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="/obs.html/static/flexsearch.bundle.js"></script>
<script src="/obs.html/static/pako.js"></script>
<script src="/obs.html/static/search.js"></script>
<script src="/obs.html/static/dirtree.js"></script>




                <!-- Onload tweaks -->
                <script>
                        const CURRENT_NODE = 'overview of architecture';
                        const HTML_URL_PREFIX = '';
                        const PAGE_DEPTH = 3;
                </script>
        </head>

<body class="theme-obs-light">
        <div id="antiflash" style="display: none;"></div>
        <script>
                document.getElementById('antiflash').style.display = 'block';
        </script>
        <div id="search-master-div">
    <div id="search-slab" king_ramses="return the slaaab">
            <div id="search-controls">
                    <input id="search_string" placeholder="Type to search notes" type="text" />
                    <div class="tooltip" style="display: none;">
                        <input type="checkbox" id="hard_search" name="hard" />
                        <span class="tooltiptext">Hard search (require exact match)</span>
                    </div>
                    <div id="search-results-box">
                        <div id="search-results"></div>
                    </div>
                    <div id="search-instructions">
                        <div class="prompt-instruction mobile">
                            <button onclick="toggle_id('search-master-div');"><b>Close</b> Search </button>
                        </div>
                    </div>
            </div>
    </div>
</div>

<script>
    document.getElementById("search-master-div").addEventListener('click', e => {
            if(e.target !== e.currentTarget){
                    return
            }
            toggle_id('search-master-div');
    })
    document.getElementById("search_string").addEventListener("input", function(event) {
            setTimeout( () =>run_search('search_string', 'hard_search'), 100 );
    }); 
    document.getElementById("hard_search").addEventListener("click", function(event) {
            setTimeout( () =>run_search('search_string', 'hard_search'), 100 );
    });

    window.addEventListener('keydown', e => {
        if((e.key=='Escape'||e.key=='Esc'||e.keyCode==27)){
            toggle_id('search-master-div');
            return false;
        } 
    }, true);

    function click_list_link(element){
        element.parentElement.getElementsByTagName('a')[0].click()
    }
</script>

        <div id="page_holder" class="flex_col">
                <div id="header" class="header">
    <div id="header_flex" class="flex_row">
            <a href="/index.html" id="homelink" title="Clear screen and go to homepage">QuantumPeepz/RedPitayaGuide</a>
            <div id="menu_toggle_button" class="navbar-button requires_js" onclick="toggle_menu()">
                    ≡
            </div>
            <div id="navbar" class="navbar requires_js">
                    
                    <div class="icon-tray">
                            <div id="theme-button" class="theme-button requires_js" title="Change theme" onclick="toggle_theme_popup(this)">
    T
</div>
<script>
    function toggle_theme_popup(el){
        // make theme button show that it's active by adding the .active class
        toggle(el);

        // show the theme selector
        toggle_id('theme-popup')

        let h2 = document.getElementById('header2')
        if (h2){
            let pu = document.getElementById('header2').getElementsByClassName('popup')[0];
            toggle(pu);
        }
    }

    function disable_theme_popup(){
        disable_id('theme-button');

        // show the theme selector
        disable_id('theme-popup')

        let h2 = document.getElementById('header2')
        if (h2){
            let pu = document.getElementById('header2').getElementsByClassName('popup')[0];
            disable(pu);
        }
    }
</script>
                                    <div onclick="openSearch()" class="theme-button requires_js">
            <img src = "/obs.html/static/search.svg" alt="Search notes" title="Search notes" style="margin: 4px;"/>
        </div>
        <script>
            function openSearch(){
                // toggle search popup and continue with extra code if it is enabled this time
                if (toggle_id('search-master-div')){
                    // get input field and temporarily disable it
                    let ss = document.getElementById('search_string');
                    ss.value = 'Seach data initializing...';
                    ss.readOnly = true; 

                    // load search data if not yet done so
                    setTimeout(function(){
                        LoadSearchData()

                        // clear input and put focus on it so that we can start typing immediately
                        ss.value = '';
                        ss.readOnly = false; 
                        ss.focus()
                        ss.select()
                    }, 100);
                }
            }
        </script>
                                    <div class="graph_header_div requires_js">
            <a id="graph_link" class="system-link" href="/obs.html/graph/index.html?node=overview of architecture" title="Open fullpage Graph">
                    <img class="graph_header_div_svg" src = "/obs.html/static/graph.svg" alt="Open fullpage Graph" style="margin: 2px; width: 17px;"/>
            </a>
        </div>
                                    <div >
            <a id="dirtree_link" class="system-link" href="/obs.html/dir_index.html" title="View directory tree">
                    <img src = "/obs.html/static/dirtree.svg" style="width: 12px; padding: 4px;" alt="Directory tree link"/>
            </a>
        </div>
                            <div>
    <a href="/obs.html/tags/index.html" title="Open tag view">
            <img src = "/obs.html/static/hashtag.svg" alt="RSS Feed link" style="width: 24px; margin-left: -2px; margin-top: -2px;"/>
    </a>
</div>
                            
                    </div>
                    <div style="display: flex; flex-direction:column">
                        <div id="left_pane_toggle_nav" class="left_pane_toggle_nav">Toggle Directory Tree Pane</div>
                        <div id="right_pane_toggle_nav" class="right_pane_toggle_nav">Toggle Table of Contents Pane</div>
                    </div>
            </div>
    </div>
    <div class="popup" id="theme-popup">
    <label for="cars">Theme </label>

    <select name="theme" id="theme" onchange="set_theme(this.value)">
      <option value="obs-light" selected="selected">obsidian-light</option>
      <option value="obs-dark">obsidian-dark</option>
    </select> 
</div>
</div>
                <div class="flex_row">
                        <div id="left_pane" class="left_pane active">
    <div id="left_pane_fold_header" class="left_pane_fold_header fold_header">x</div>
    <div id="left_pane_content" class="left_pane_content">
            <div id="dirtree"><button id="folder-1" class="dir-button active" onclick="toggle_dir(this.id)"><div class="file-icon"></div>Red Pitaya Guide</button>
<div id="folder-container-1" class="dir-container requires_js active" path="/Red Pitaya Guide">
	<button id="folder-2" class="dir-button " onclick="toggle_dir(this.id)"><div class="file-icon"></div>Attachments</button>
	<div id="folder-container-2" class="dir-container requires_js " path="/Red Pitaya Guide/Attachments">
		<ul class="dir-list">
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/RedPitaya.PNG"  class="external-link">RedPitaya.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/RedPitaya_web_server.PNG"  class="external-link">RedPitaya_web_server.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/RedPitaya_web_server_ip.PNG"  class="external-link">RedPitaya_web_server_ip.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/matlab_System_generator_Block.PNG"  class="external-link">matlab_System_generator_Block.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/matlab_System_generator_Block-clocking.PNG"  class="external-link">matlab_System_generator_Block-clocking.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/matlab_System_generator_Block_Ip_catalog.PNG"  class="external-link">matlab_System_generator_Block_Ip_catalog.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/matlab_umgebungsvariablen.PNG"  class="external-link">matlab_umgebungsvariablen.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/putty_connection_interface.PNG"  class="external-link">putty_connection_interface.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/putty_run_bitstream.PNG"  class="external-link">putty_run_bitstream.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/scematicsRedPitaya.svg"  class="external-link">scematicsRedPitaya.svg</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/vivado_block_design.PNG"  class="external-link">vivado_block_design.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/vivado_generate_bitstream.PNG"  class="external-link">vivado_generate_bitstream.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/vivado_ip_catalog.PNG"  class="external-link">vivado_ip_catalog.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/vivado_template_project_path.PNG"  class="external-link">vivado_template_project_path.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/vivado_user_repository.PNG"  class="external-link">vivado_user_repository.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/winSCP_bitstream_file.PNG"  class="external-link">winSCP_bitstream_file.PNG</a></li>
			<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Attachments/winSCP_login_to_redPitaya.PNG"  class="external-link">winSCP_login_to_redPitaya.PNG</a></li>
		</ul>
	</div>
	<button id="folder-3" class="dir-button " onclick="toggle_dir(this.id)"><div class="file-icon"></div>Dev</button>
	<div id="folder-container-3" class="dir-container requires_js " path="/Red Pitaya Guide/Dev">
		<ul class="dir-list">
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Dev/Creating external clock.html"  >Creating external clock</a></li>
		</ul>
	</div>
	<button id="folder-4" class="dir-button active" onclick="toggle_dir(this.id)"><div class="file-icon"></div>Internal reference design</button>
	<div id="folder-container-4" class="dir-container requires_js active" path="/Red Pitaya Guide/Internal reference design">
		<button id="folder-5" class="dir-button active" onclick="toggle_dir(this.id)"><div class="file-icon"></div>ARM</button>
		<div id="folder-container-5" class="dir-container requires_js active" path="/Red Pitaya Guide/Internal reference design/ARM">
			<button id="folder-6" class="dir-button " onclick="toggle_dir(this.id)"><div class="file-icon"></div>attachments</button>
			<div id="folder-container-6" class="dir-container requires_js " path="/Red Pitaya Guide/Internal reference design/ARM/attachments">
				<ul class="dir-list">
					<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Internal reference design/ARM/attachments/config_structure.svg"  class="external-link">config_structure.svg</a></li>
				</ul>
			</div>
			<ul class="dir-list">
				<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Internal reference design/ARM/Creating AXI interface with System generator (Model composer).html"  >Creating AXI interface with System generator (Model composer)</a></li>
				<li><div class="file-icon"></div><a class="active current_page_dirtree" href="/Red Pitaya Guide/Internal reference design/ARM/Overview of architecture.html"  >Overview of architecture</a></li>
				<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Internal reference design/ARM/Reference design message overview.html"  >Reference design message overview</a></li>
				<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Internal reference design/ARM/Server library.html"  >Server library</a></li>
			</ul>
		</div>
		<button id="folder-7" class="dir-button " onclick="toggle_dir(this.id)"><div class="file-icon"></div>Vivado</button>
		<div id="folder-container-7" class="dir-container requires_js " path="/Red Pitaya Guide/Internal reference design/Vivado">
			<ul class="dir-list">
				<li><div class="file-icon non-md-file"></div><a class="" href="/Red Pitaya Guide/Internal reference design/Vivado/RefProjectDecisionTree.excalidraw.png"  class="external-link">RefProjectDecisionTree.excalidraw.png</a></li>
				<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Internal reference design/Vivado/Reference project documentation.html"  >Reference project documentation</a></li>
			</ul>
		</div>
		<ul class="dir-list">
		</ul>
	</div>
	<button id="folder-8" class="dir-button " onclick="toggle_dir(this.id)"><div class="file-icon"></div>Issues</button>
	<div id="folder-container-8" class="dir-container requires_js " path="/Red Pitaya Guide/Issues">
		<ul class="dir-list">
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Adding folder as IP repository.html"  >Adding folder as IP repository</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Compiling and running C app for Red Pitaya.html"  >Compiling and running C app for Red Pitaya</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/DMA operation for data recording.html"  >DMA operation for data recording</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Git repository structure.html"  >Git repository structure</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Memory-mapped address mess.html"  >Memory-mapped address mess</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Model composer default Matlab.html"  >Model composer default Matlab</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Reading 64bit value from 32bit register.html"  >Reading 64bit value from 32bit register</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Rebuilding reference project.html"  >Rebuilding reference project</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Red Pitaya reserved DDR memory patch.html"  >Red Pitaya reserved DDR memory patch</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Running bash script for compilation.html"  >Running bash script for compilation</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Setting up Rust Cross-compiling.html"  >Setting up Rust Cross-compiling</a></li>
			<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/Issues/Vivado workflow with AXI4 IP core.html"  >Vivado workflow with AXI4 IP core</a></li>
		</ul>
	</div>
	<ul class="dir-list">
		<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/FAQ.html"  >FAQ</a></li>
		<li><div class="file-icon"></div><a class="" href="/Red Pitaya Guide/First steps.html"  >First steps</a></li>
	</ul>
</div>
<ul class="dir-list">
	<li><div class="file-icon"></div><a class="" href="/index.html"  >index</a></li>
</ul>
</div>
    </div>
</div>
                        <div class="container">
                                <div class="content"><h1 id="overview-of-architecture">Overview of architecture</h1>
<h2 id="intro">Intro</h2>
<p>This section of the guide introduces one of the possibilities for interfacing Programmable logic (PL) with ARM processor (PS) in Zynq SoC and even PC. This allows you to design IP cores that are easily configurable at runtime and greatly increases the flexibility of your designs. Note that this guide follows one particular style/architecture and some components and procedures might be more or less stand alone.   </p>
<div class="callout callout-note active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><line x1="18" y1="2" x2="22" y2="6"></line><path d="M7.5 20.5L19 9l-4-4L3.5 16.5 2 22z"></path></svg>
</div>
<div class="callout-title-name">Note
</div>
</div>
<div class="callout-content">
<p>If you are reading this you should already be familiar with <a href="/Red%20Pitaya%20Guide/First%20steps.html#hardwareaufbau-zum-testen-des-fpga">how to work with Red Pitaya</a> and basic <a href="/Red%20Pitaya%20Guide/First%20steps.html#work-with-vivado">Vivado</a> and <a href="/Red%20Pitaya%20Guide/First%20steps.html#preparing-a-bitstreams-in-simulink">System generator/Model composer</a> workflows.</p>
</div>
</div>
<ul>
<li>If you are interested only in how to interact with AXI interface you set up for your IP core, skip to <a href="#mapping-axi4-lite-interface-in-c-code" class="anchor-link">Mapping AXI4(-Lite) interface in C code</a>.   </li>
<li>To learn how to set up IP core with AXI interface in System generator, follow <a href="/Red%20Pitaya%20Guide/Internal%20reference%20design/ARM/Creating%20AXI%20interface%20with%20System%20generator%20%28Model%20composer%29.html">this</a>.   </li>
<li>For TCP Server-Client protocol overview, skip <a href="#tcp-ip-protocol" class="anchor-link">TCP/IP protocol</a>.   </li>
<li>For overview of built-in TCP message types in reference design, go <a href="/Red%20Pitaya%20Guide/Internal%20reference%20design/ARM/Reference%20design%20message%20overview.html">here</a>.   </li>
</ul>
<h3 id="general-idea">General idea</h3>
<p>PL is running some high-throughput operation (e.g. LQG) but you want to be able change some parameters on the fly, or correct an input offset of ADC, switch between different sources for output, etc. To do that, you add AXI interface (e.g. AXI4-Lite) to your IP core which is connected to Zynq7 IP core (kind of representation of the ARM processor). This ultimately allows the processor to access and write/read registers.    </p>
<p>To facilitate the actual the actual interaction with the registers, you can write code in any language supporting memory-mapped interface, in this case it's C code for Linux running on the ARM processor. If you wish the access to the greater computational potential of a PC, you can leverage the Ethernet connection you probably have already hooked up and set up a TCP/IP socket to communicate between PC (running Matlab app) and ARM processor.   </p>
<p>Simplified dataflow in this scenario is as follows: <br />
<strong>Matlab App</strong> &lt;--TCP/IP--&gt; <strong>C server on Linux</strong> &lt;--AXI--&gt; <strong>Programmable logic</strong>   </p>
<p><img alt="" src="/Red%20Pitaya%20Guide/Internal%20reference%20design/ARM/attachments/config_structure.svg" />   </p>
<h2 id="mapping-axi4-lite-interface-in-c-code">Mapping AXI4(-Lite) interface in C code</h2>
<div class="callout callout-bug active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><rect x="8" y="6" width="8" height="14" rx="4"></rect><path d="M19 7l-3 2"></path><path d="M5 7l3 2"></path><path d="M19 19l-3-2"></path><path d="M5 19l3-2"></path><path d="M20 13h-4"></path><path d="M4 13h4"></path><path d="M10 4l1 2"></path><path d="M14 4l-1 2"></path></svg>
</div>
<div class="callout-title-name">32bit vs 8bit alignment <br />
</div>
</div>
<div class="callout-content">
<p>It is important to clarify what we mean by 32bit (<strong>word</strong>) and 8bit (<strong>byte</strong>) address alignment: <br />
<br />
As a rule of thumb, when working from the hardware perspective (i.e. Vivado and HDL), addresses are in 8-bit aligned environment. This means addresses are accessible in byte-sized chunks. However, ARM processor works with 32-bit aligned addresses, meaning single byte value can't be accessed independently, but only as a part of 32-bit word. See <a href="/Red%20Pitaya%20Guide/Issues/Memory-mapped%20address%20mess.html">Memory-mapped address mess</a> for possibly helpful graphic</p>
</div>
</div>
<p>Open your TCP server code and follow the following steps:   </p>
<p>First, physical memory "device" has to be opened (if you are working from a reference design, this is already in the code) and then pointers mapped to the individual IP cores, such as:   </p>
<div class="lang-C">

<div class="codehilite"><pre><span></span><code><span class="cp">#define IP_CORE_MASTER_BASE_OFFSET 0x40004000</span>

<span class="c1">// Open /dev/mem which represents the whole physical memory</span>
<span class="kt">int</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/mem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_SYNC</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Create reference (pointer) to a IP core</span>
<span class="c1">// with length 0xFFFF (in bytes)</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size_of_register_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">;</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ip_core_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">size_of_register_space</span><span class="p">,</span>
<span class="w">         </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">dh</span><span class="p">,</span><span class="w"> </span><span class="n">IP_CORE_MASTER_BASE_OFFSET</span><span class="p">);</span>
</code></pre></div>


</div>

<p>Afterwards, you are able to access the registers within the IP core using functions from the <code>boyz_RP_library.c</code>, like:   </p>
<div class="lang-C">

<div class="codehilite"><pre><span></span><code><span class="c1">// Update register 1 of IP core 1 with address 0x100 with new_word </span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">new_word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2023</span><span class="p">;</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">register_1_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span>

<span class="n">write_reg_word</span><span class="p">(</span><span class="n">ip_core_pointer</span><span class="p">,</span><span class="w"> </span><span class="n">register_1_offset</span><span class="p">,</span><span class="w"> </span><span class="n">new_word</span><span class="p">);</span>

<span class="c1">// Update register 2 of IP core 1 with address 0x07 with new_byte </span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">new_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">register_2_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x07</span><span class="p">;</span>

<span class="n">write_reg_word</span><span class="p">(</span><span class="n">ip_core_pointer</span><span class="p">,</span><span class="w"> </span><span class="n">register_2_offset</span><span class="p">,</span><span class="w"> </span><span class="n">new_byte</span><span class="p">);</span>
</code></pre></div>


</div>

<div class="callout callout-warning active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
</div>
<div class="callout-title-name">Warning
</div>
</div>
<div class="callout-content">
<p>Note that user is responsible for type-casting the data for the register! Functions from the provided library always accept unsigned integer (32 or 8bit) to avoid any typecasting issues, hence provide the value with the bit format of the target register datatype.</p>
</div>
</div>
<h2 id="tcp-ip-protocol">TCP/IP protocol</h2>
<p>As an option to provide greater flexibility for configuration and interaction of the implemented designs, simple protocol over the TCP/IP socket is utilized. In this case Matlab App serves as a TCP client, but it could be any other TCP/IP capable software/code.   </p>
<h3 id="description">Description</h3>
<div class="lang-mermaid">

<div class="mermaid">
sequenceDiagram
    participant C as Matlab App
    participant S as TCP Server (ARM)

    Note over C: Callback reconfigures registers in an IP core
    C->>S: HEADER+(payload as 8bit array)
    Note over C,S: Processing time
    S->>C: ACK
    Note over C: Callback request some data from Red Pitaya
    C->>S: HEADER+(payload as 8bit array)
    Note over C,S: Processing time
    S->>C: (Arbitrary 8bit array/stream)

</div>

</div>

<h3 id="notes">Notes</h3>
<ul>
<li>The communication is set up as blocking (generally), so avoid sending two requests without receiving response. In better scenario the second request will be ignored, but more probably something will break.   </li>
<li>As of December 2023, any exchange is initiated only by the Client (Matlab App)   </li>
<li>Due to the implementation of parsing the incoming message in the TCP server, avoid using partial names of already existing headers.    <ul>
<li>If there already exists a header called <em>ADC_CFG</em> and then another <em>ADC_CFG2</em>, only the former would be executed.   </li>
</ul>
</li>
<li>Structure of individual message is fixed and has to be determined (and kept up to date in face of any modifications) by the programmer   </li>
</ul>
<h3 id="protocol-implementation">Protocol implementation</h3>
<p>Note that this section covers only the bare minimum of how to add additional messages in the already existing reference design, namely <code>TCP_server_min_example.c</code> and <code>TCP_client_min_example.c</code>.   </p>
<h4 id="tcp-server-c-code">TCP Server (C code)</h4>
<p>Locate the main while loop starting with line <code>while (server_run == 1)</code>, then find an if-else statement defined by <code>if (read_size == 0)</code>. The <em>else</em> branch of the latter statement is where the magic happens - code there gets executed every time data is received<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> from TCP client <code>client_sock</code>.  Within the branch there are <code>if(strstr(...) != NULL )</code> statements for each unique message, you are welcome to explore a couple to explore the possibilities.   </p>
<p>Following codes outlines how to add custom message <code>USR_MSG</code> to the existing structure:   </p>
<div class="lang-C">

<div class="codehilite"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="n">rcvBuff</span><span class="p">[</span><span class="mi">1025</span><span class="p">];</span><span class="w"> </span><span class="c1">// Buffer for storing incoming data</span>
<span class="p">...</span>
<span class="n">read_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recv</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span><span class="w"> </span><span class="n">rcvBuff</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rcvBuff</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span>
<span class="c1">// read_size is number of bytes received</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"> </span><span class="c1">// No message</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="c1">// Something in receive Buffer</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">read_size</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RAM_rec_primed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w"> </span><span class="c1">// Start recording by TCP trigger</span>
<span class="w">           </span><span class="p">...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">...</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">rcvBuff</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SAVE_CSV&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="c1">//Save RAM to csv</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">num_channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countSetBits</span><span class="p">(</span><span class="n">RAM_rec_channels</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">saveCSVfromRAM</span><span class="p">(...){</span>
<span class="w">                </span><span class="c1">// Procedure successful, send acknowledge</span>
<span class="w">                </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ACK&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">send</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error writing csv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Procedure unsuccessful, send error message</span>
<span class="w">                </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;CSV_FAIL&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">send</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="c1">// skip to next iteration of while loop/ next message</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="c1">//BEGIN - THIS IS WHERE USER CODE IS ADDED</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">rcvBuff</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;USR_MSG&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="c1">//</span>
<span class="w">        </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">data_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="c1">//Index for rcvBuff, pointing to the first byte following the header</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">register_1_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">register_2_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">num_of_registers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">            </span><span class="cm">/* Following function writes continuous register space,</span>
<span class="cm">            starting from register_1_offset, writing num_of_registers</span>
<span class="cm">            successive addresses.</span>

<span class="cm">            In this case, it writes addresses 0x00,0x04,0x08 up to 0x0C</span>
<span class="cm">            */</span><span class="w"> </span>
<span class="w">            </span><span class="n">write_reg_block</span><span class="p">(</span><span class="n">ip_core_1_pointer</span><span class="p">,</span>
<span class="w">                            </span><span class="n">register_1_offset</span><span class="p">,</span>
<span class="w">                            </span><span class="n">rcvBuff</span><span class="o">+</span><span class="n">data_idx</span><span class="p">,</span>
<span class="w">                            </span><span class="n">num_of_registers</span><span class="p">);</span>

<span class="w">            </span><span class="c1">//Shift the data index accordingly</span>
<span class="w">            </span><span class="n">data_idx</span><span class="o">+=</span><span class="mi">4</span><span class="o">*</span><span class="n">num_of_registers</span><span class="p">;</span><span class="w"> </span>

<span class="w">            </span><span class="c1">//EITHER</span>
<span class="w">            </span><span class="c1">// Concatenate byte array to 32bit value</span>
<span class="w">            </span><span class="c1">// first manually, then update register.</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">new_reg_2_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uint8_to_double</span><span class="p">(</span><span class="n">rcvBuff</span><span class="o">+</span><span class="n">data_idx</span><span class="p">);</span>

<span class="w">            </span><span class="n">write_reg_word</span><span class="p">(</span><span class="n">ip_core_2_pointer</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">register_2_offset</span><span class="p">,</span>
<span class="w">                           </span><span class="n">new_reg_2_value</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//OR </span>
<span class="w">            </span><span class="c1">// Use write_reg_block to convert and write</span>
<span class="w">            </span><span class="c1">// (results in the same functionality)</span>
<span class="w">            </span><span class="n">write_reg_block</span><span class="p">(</span><span class="n">ip_core_2_pointer</span><span class="p">,</span>
<span class="w">                            </span><span class="n">register_2_offset</span><span class="p">,</span>
<span class="w">                            </span><span class="n">rcvBuff</span><span class="o">+</span><span class="n">data_idx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">data_idx</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>

<span class="w">            </span><span class="cm">/* Since there&#39;s no functionality to go wrong,</span>
<span class="cm">            send always acknowledge.</span>
<span class="cm">            */</span>

<span class="w">            </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ACK&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">send</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//END - THIS IS WHERE USER CODE IS ADDED</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


</div>

<h4 id="matlab-app-code">Matlab App code</h4>
<p>Starting from <em>TCP_client_min_example.mlapp</em> is recommended and this section follows this scenario. Otherwise you need to set up basic TCP client in your app.    </p>
<p>Following code is the other half of the example above, written in arbitrary callback function:   </p>
<div class="lang-Matlab">

<div class="codehilite"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">ButtonPushed</span><span class="p">(</span>app, event<span class="p">)</span>
<span class="w">    </span><span class="n">parameter_1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">EditField_1</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="w">    </span><span class="n">parameter_2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">EditField_2</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>

<span class="w">    </span><span class="n">array</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parameter_1</span><span class="o">.*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2.25</span><span class="p">,</span><span class="w"> </span><span class="mf">3.75</span><span class="p">,</span><span class="w"> </span><span class="nb">pi</span><span class="p">];</span>

<span class="w">    </span><span class="c">% Convert the data to correct representation and the typecast to byte array</span>
<span class="w">    </span><span class="n">signed</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">bit_width</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<span class="w">    </span><span class="n">fraction_width</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="n">fix_array</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fix2uint8array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span>
<span class="w">                               </span><span class="n">signed</span><span class="p">,</span>
<span class="w">                               </span><span class="n">bit_width</span><span class="p">,</span>
<span class="w">                               </span><span class="n">fraction_width</span><span class="p">);</span>

<span class="w">    </span><span class="n">fix_parameter_2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fix2uint8array</span><span class="p">(</span><span class="n">parameter_2</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">signed</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">bit_width</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">fraction_width</span><span class="p">);</span>

<span class="w">    </span><span class="c">% Assemble payload as a row uint8/char vector</span>
<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">fix_array</span><span class="p">,</span><span class="w"> </span><span class="n">fix_parameter_2</span><span class="p">];</span>

<span class="w">    </span><span class="c">% Add header and send the message</span>
<span class="w">    </span><span class="n">msgout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;USR_MSG&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">];</span>
<span class="w">    </span><span class="nb">write</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">RP_client</span><span class="p">,</span><span class="w"> </span><span class="n">msgout</span><span class="p">);</span>

<span class="w">    </span><span class="c">% Wait for acknowledge before leaving the function</span>
<span class="w">    </span><span class="n">waitForAck</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></div>


</div>

<script>
                    function initializeMermaid() {
                        mermaid.initialize({startOnLoad:true})
                    }

                    if (document.readyState === "complete" || document.readyState === "interactive") {
                        setTimeout(initializeMermaid, 1);
                    } else {
                        document.addEventListener("DOMContentLoaded", initializeMermaid);
                    }
            </script>

<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>By default the <code>recv(...)</code> command is set up as blocking, which means it will stall the execution until there's something in the buffer. If you wish to change this behavior, use function <code>SetSocketBlockingEnabled(int fd, bool blocking)</code> .&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 0 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
<div class="note-footer">
<div class="backlinks">
<h2>Backlinks</h2>
<ul>
	<li><a class="backlink" href="/index.html">index</a></li>
</ul>
</div>

<div class="tags">
<h2>Tags</h2>
<ul>
	<li><a class="backlink" href="/obs.html/tags/define/index.html">define</a></li>
</ul>
</div>

</div>
<div class="graph requires_js ">
    <div id="A177292715545002761445853335630468745909{level}" class="graph_div"></div>

    <div class="graph-instructions" id="D177292715545002761445853335630468745909{level}">
        Left-click: follow link, Right-click: select node, Scroll: zoom
    </div>
    
    <div class="graph-button-row" style="display:flex;">
        <button class="graph_button graph_show_button" id="B177292715545002761445853335630468745909{level}" level="{level}" note_temp_id="177292715545002761445853335630468745909" onclick="window.ObsHtmlGraph.run(this, '177292715545002761445853335630468745909', 'overview of architecture');">
            Show Graph
        </button>
        <button class="graph_button graph_type_button" id="C177292715545002761445853335630468745909{level}" style="flex:1" onclick="window.ObsHtmlGraph.switch_graph_type(this);">
            2D
        </button>
    </div>
</div>

<script type="module">
    if (window.ObsHtmlGraph == undefined){
        import('/obs.html/static/graph.js').then((Module) => {
            window.ObsHtmlGraph = Module;
            window.ObsHtmlGraph.arm_page(document.getElementById('page_holder'))
        })
    }
</script>




                                <!-- end content -->
                        </div>
                        <div class="container_filler">
                        </div>
                        <div id="right_pane" class="right_pane active">
    <div id="right_pane_fold_header" class="right_pane_fold_header fold_header">x</div>
    <div id="right_pane_content" class="right_pane_content">
            
    </div>
</div>
                </div>
        </div>

        <script>
                function handle_toggle_side_bar(e){
                        let header;
                        let pane; 
                        let target = e.target

                        // switch out the navbar button click for a header click
                        if (target.id == 'left_pane_toggle_nav'){
                                target = document.getElementById('left_pane_fold_header')
                        }
                        else if (target.id == 'right_pane_toggle_nav'){
                                target = document.getElementById('right_pane_fold_header')
                        }

                        // get header and pane
                        if (target.classList.contains('fold_header')) {
                                header = target;
                                pane = target.parentElement;
                        }
                        else {
                                pane = target;
                                header = target.getElementsByClassName('fold_header')[0];
                        }
                        toggle_side_bar(pane, header, true)
                        e.stopPropagation();
                }
                function handle_toggle_side_bar_button(e){
                        document.getElementById('menu_toggle_button').click()
                        handle_toggle_side_bar(e);
                }

                function toggle_side_bar(pane, header, save) {
                        let active = (pane.classList.contains('active'))
                        if (active){
                                disable_side_bar(pane, header, save);
                        }
                        else {
                                enable_side_bar(pane, header, save);
                        }
                }
                function enable_side_bar(pane, header, save){
                        pane.classList.add('active');
                        pane.removeEventListener('click', handle_toggle_side_bar);
                        header.addEventListener('click', handle_toggle_side_bar);
                        set_correct_header_symbol(header);
                        if (save){ save_panel_folding_state(header, true) }
                }
                function disable_side_bar(pane, header, save){
                        pane.classList.remove('active');
                        pane.addEventListener('click', handle_toggle_side_bar);
                        header.removeEventListener('click', handle_toggle_side_bar);
                        set_correct_header_symbol(header);
                        if (save){ save_panel_folding_state(header, false) }
                }
                function set_correct_header_symbol(header){
                        let pane = header.parentElement;
                        let symbol = [['>', '<'],['<', '>']]
                        symbol = symbol[Number(header.classList.contains('right_pane_fold_header'))][Number(pane.classList.contains('active'))];
                        console.log(symbol);
                        header.innerHTML = symbol
                        return header;
                }
                function panel_folding_get_panel_name(header){
                        return ['left', 'right'][Number(header.classList.contains('right_pane_fold_header'))]
                }
                function save_panel_folding_state(header, active){
                        ls_set('pane_folding_state_'+panel_folding_get_panel_name(header), Number(active));
                }
                function load_panel_folding_state(panel_name){
                        val = ls_get('pane_folding_state_'+panel_name)
                        if (!val){ return {'exists': false, 'value': null}}
                        return {'exists': true, 'value': Boolean(Number(val))}
                }
                function set_pane_folding_start(left_header, right_header){
                        // small screen = closed
                        let right_pane_enabled = true;
                        let left_pane_enabled = true;
                        let w = window.visualViewport.width
                        if (w < 1000){
                                left_pane_enabled = false
                        }
                        if (w < 800){
                                right_pane_enabled = false
                        }

                        // get saved values if present
                        let rval = load_panel_folding_state('right')
                        if (rval['exists']){
                                right_pane_enabled = rval['value']
                        }
                        let lval = load_panel_folding_state('left')
                        if (lval['exists']){
                                left_pane_enabled = lval['value']
                        }

                        // default = enabled, so we only need to disable
                        if (!left_pane_enabled){
                                disable_side_bar(document.getElementById('left_pane'), document.getElementById('left_pane_fold_header'))
                        }
                        if (!right_pane_enabled){
                                disable_side_bar(document.getElementById('right_pane'), document.getElementById('right_pane_fold_header'))
                        }
                }

                function init_pane_folding(header){
                        set_correct_header_symbol(header);
                        header.addEventListener('click', handle_toggle_side_bar);
                }
                
                
                set_pane_folding_start()
                init_pane_folding(document.getElementById('left_pane_fold_header'));
                init_pane_folding(document.getElementById('right_pane_fold_header'));

                document.getElementById('left_pane_toggle_nav').addEventListener('click', handle_toggle_side_bar_button);
                document.getElementById('right_pane_toggle_nav').addEventListener('click', handle_toggle_side_bar_button);
        </script>

        <script src="/obs.html/static/load_dirtree_footer.js" type="text/javascript"></script>

        




</body>
</html>
